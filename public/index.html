<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
        <title>Go WASM + DOM File Upload</title>
        <script src="wasm_exec.js"></script>
        <script src="/assets/jszip.min.js"></script>
        <script src="/assets/FileSaver.min.js"></script>
    </head>
<body>
    <div class="container">
        <h1 >Upload a File</h1>
        <span id="error"></span>
        <div class="file-input">
            <input type="file" id="fileInput" accept="image/gif" />
            <pre id="output">Waiting for file...</pre>
        </div>
        <div class="convert" style="display: none;">
<!--             
            <select name="disposeType" id="disposeType">
                <option value="auto" default>Auto (default)</option>
                <option value="background">Preserve background</option>
                <option value="previous">Preserve previous frame data</option> 
            </select> -->
            <button id="start">Start Conversion</button>
        </div>
        <div class="progress" style="display: none;">
            <span id="loading" aria-busy="true">Splitting frames...</span>
            <progress id="progress" value="0" max="100"></progress>
        </div>
        <div class="output-frames" style="display: none;">
            <p id="framecount"></p>
            <button id="download">Download zip</button>
            <button id="newconvert">Convert Again</button>
            <div class="out-image"></div>
        </div>


    
        <script>
            // TODO
            // Fix the progress bar not updating
            // Add popup for large file sizes
            // Attempt go routines for faster processing
            let zip
            let gifFrames = [];
            let startBtn = document.querySelector('#start');
            let downloadBtn = document.querySelector('#download');
            let progBar = document.querySelector('#progress');
            let loadingText = document.querySelector('#loading');
            let disposeType = document.querySelector('#disposeType');

            document.querySelector('#newconvert').addEventListener('click', function() {
                document.querySelector('#fileInput').value = ''; // Reset file input
                document.querySelector('.out-image').innerHTML = '';//Clears previous images output
                gifFrames = []; // Clear previous frames
                showScene('.file-input');
            });

            document.querySelector('#fileInput').addEventListener('change', function(){
                console.log("File input changed");
    
                //Checks if a file is selected
                if (this.files.length === 0) {
                    displayError("No file selected");
                    return;
                }
    
                //Verifies the file type is a GIF
                if (this.files[0].type !== "image/gif") {
                    displayError("Please upload a GIF file");
                    return;
                }
    
    
                const blob = new Blob([this.files[0]], { type: this.files[0].type });
                console.log(this.files)
                const filePreview = document.createElement('img');
                filePreview.src = URL.createObjectURL(blob);
                filePreview.id = 'preview';

                node = document.querySelector('.convert');
                if (node.querySelector('#preview')) {
                    node.removeChild(node.querySelector('#preview'));
                }
                node.insertBefore(filePreview, node.firstChild);

    
    
    
                startBtn.onclick = async function() {
                    let outputFramesDOM = document.querySelector('.out-image')
                    outputFramesDOM.innerHTML = ''; // Clear previous images
                    console.time("decode")
                    setProgress(0, 100);
                    showScene('.progress');
                    // Converts the file to an ArrayBuffer for processing in Go
                    const arrayBuf = await blob.arrayBuffer()
                    const array = new Uint8Array(arrayBuf);
                    console.log("Starting conversion with dispose type: " + disposeType.value);
                    let frames = await convert(array, disposeType.value);
                    console.log("Conversion complete, displaying image");

                    
                    zip = new JSZip();
                    frames.forEach((frame, i) => {
                        let blob = new Blob([frame], { type: 'image/png' });
                        let newImageElement = document.createElement('img');
                        newImageElement.src = URL.createObjectURL(blob);
                        outputFramesDOM.appendChild(newImageElement);

                        zip.file(`frame_${i}.png`, blob)
                    });

                    // Function to download the zip file
                    function downloadZip(){
                        zip.generateAsync({ type: "blob" }).then(function(blob){
                            saveAs(blob, "frames.zip");
                        })
                    }
        
                    showScene('.output-frames');
                    downloadBtn.onclick = downloadZip;
                }
    
                showScene('.convert');
                
    
            })
    
    
            function displayError(errorMessage) {
                document.querySelector('#error').textContent = errorMessage;
                console.log("Error: " + errorMessage);
            }
    
            function checkTime(){
                console.timeLog("decode");
            }

            function setProgress(cur, max) {
                if (progBar) {
                    progBar.value = cur;
                    progBar.max = max;
                }
            }

            function showScene(scene) {
                [".file-input",
                 ".convert",
                 ".progress",
                 ".output-frames"].forEach(selector => {
                    if (scene === selector) {
                        document.querySelector(selector).style.display = 'inline-block';
                    } else {
                        document.querySelector(selector).style.display = 'none';
                    }
                });
            }
            
            function log(message) {
                console.log(message);
            }
            
    
            // Initialises the Go environment and runs the WebAssembly module.
            const go = new Go();
            WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject).then((result) => {
            go.run(result.instance);
            });
        </script>
    </div>
</body>
</html>
