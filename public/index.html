<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Go WASM + DOM File Upload</title>
        <script src="wasm_exec.js"></script>
        <script src="/assets/jszip.min.js"></script>
        <script src="/assets/FileSaver.min.js"></script>
    </head>
<body>
    <h1 >Upload a File</h1>
    <input type="file" id="fileInput" />
    <pre id="output">Waiting for file...</pre>
    <span id="error"></span>
    <button id="download" style="display: none;">Download zip</button>
    <div class="out-image"></div>

    <script>
        let gifFrames = [];
        document.querySelector('#fileInput').addEventListener('change', function(){
            console.log("File input changed");
            //Clears previous images output
            node = document.querySelector('.out-image');
            while (node.firstChild) {
                node.removeChild(node.firstChild);
            }

            const blob = new Blob([this.files[0]], { type: this.files[0].type });

            // Converts the file to an ArrayBuffer for processing in Go
            const arrayBufferPromise = blob.arrayBuffer().then(arrayBuf => {
                console.time("decode")
                document.querySelector('#output').textContent = "File loaded, converting...";
                console.log("File converted to arraybuffer")
                const array = new Uint8Array(arrayBuf);
                console.log("Uint8Array created from arraybuffer");
                let convertedData = convert(array);
                console.log("Conversion complete, displaying image");
            })
        })

        //Takes a blob of image data, converts it to a PNG, and displays it
        function displayImage(imageData) {
            let blob = new Blob([imageData], { type: 'image/png' });
            gifFrames.push(blob);
            let newImageElement = document.createElement('img');
            newImageElement.src = URL.createObjectURL(blob);
            document.querySelector('.out-image').appendChild(newImageElement);
        }

        function checkTime(){
            console.timeLog("decode");
        }

        // Uses JSZip to create a zip file from the collected frames
        function createZip(){
            console.log("Decode complete, creating zip");
            console.timeLog("decode")
            console.timeEnd("decode")
            let zip = new JSZip();
            gifFrames.forEach((frame, index) => {
                zip.file(`frame_${index}.png`, frame);
            });
            gifFrames = []; // Clear frames after zipping

        // Function to download the zip file
            function downloadZip(){
                zip.generateAsync({ type: "blob" }).then(function(blob){
                    saveAs(blob, "frames.zip");
                })
            }

        // Attaches the download function to the button and shows it
            document.querySelector('#download').style.display = 'block';
            document.querySelector('#download').addEventListener('click', downloadZip);
        }

        

        // Initialises the Go environment and runs the WebAssembly module.
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject).then((result) => {
        go.run(result.instance);
        });
    </script>
</body>
</html>
